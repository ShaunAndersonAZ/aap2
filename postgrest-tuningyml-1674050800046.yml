---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# postgrest-tuning.yml
# https://console.redhat.com/insights/remediations/66813df1-94c3-4bbd-b7f2-47145953e75f
# Generated by Red Hat Insights on Wed, 18 Jan 2023 14:06:40 GMT
# Created by c1_shaunandersonaz

- name: run insights to obtain latest diagnosis info
  hosts: "ansible-ap2,ansible-ap2db,ansible-ap2hub"
  vars:
    insights_remediation: " 66813df1-94c3-4bbd-b7f2-47145953e75f"
    insights_signature_exclude: "/hosts,/vars/insights_signature,/vars/insights_remediation"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRblZqZG5jMU9FUXJhalZ3VGtGUmFtRkdVa0ZCYTBSVWNu
      UnZRVzFSVkRBdlFVODVaRlJyYlRablJHZHRabUkyVGxGMGFVNEtPWHBNYmtWcmRsaEpibVZQV2s0
      MWRGcDBPSEZWWmtaaFNYQnBSMEV5SzFGWU9GVlNaR2hWTDJOdmRIbDRLMWQ2UlZscU1sSlpaSEEz
      ZEVnM01IQXpWUXBpWjFwbVRGRTNkV2wxYm5NNGIwMXFaV3N5VURaVFVWcExXRmxhV1c0NVYyZENP
      V2R2VG5FMk9FZERXbXR3Um1KVFVqWXJTRVl3TWxwYVVUUlZTV0ZtQ21Ga05XSmplWElyZVVwbFoy
      TlFVVk5RYUhscmNtaGtaV1pQWm5ORk9YUlhlVmhXUjFwSk1ETnNXSGh3VEVaSlJsQlFZWFZRUzNB
      NE5WcHBha0Y0VjNvS2RHYzRTSGRGUjJzME5HRTFRa3BqYVdsdWQyNXJWV1pDVEc0NFVHeHVPRVF2
      TjNSc1NsZExUVWh4TmtsWVkwMW1NVzlVU1RKdWMzZDFXRkZzTUhsbWRRcHNUekYwVHpkWFpHVTJO
      QzlHT0dGdVptNVpUVUZ5TjNoamIxTTJaMU5sTDJWeWRuVnZOamt3YVVOWFYyWm5SV294WVhSd1Qx
      cDJjazF5YmxkSllYUlhDakZrYUVONFVqaGFabkE1UmxsQ2RXUnhZV05yYVhGWVNtNDBjbEppTTFo
      clFVWlNUVmQ0YTBseWJFVkdkRUZKYjJveVdrNDJabGRVYjJwQ1JVTmlRbmNLZG14RmQxWmxObGhR
      ZW5WYWVVRm9Sa0ZFZGxWcU1UZElLME01VnpCd1ZrcHlkM3BSVUV0cE1DOXJlRTFOZVV0UWJ6ZDNa
      R3BEU0dsalFtdHRRVk01TXdwR1ZYbzVUMWcxY0RRNFpIa3lhV1p6TDBOblIyMW5XWFZEWjI1UllW
      QjNWMkpHTUhkMGREQmlWVk55WldkUldWZ3JkV3hJTlhOQlJtMW9TVUZ1Ym1GdENsTkNWVUV5ZFZr
      MVpsZGlPVXhzTmpablIwcGlUSGxNY1ZSUVNFcFNTbWxXWjNKTEt6VnpTMHgyZDNnMmNqTXJjVnBr
      YTFoUVIza3hSM0ZTVlZKT1NGUUtXWFoxVm5sUGRIZHZVV2xCUm1rdlJYWmxPV05xV2xwdWEwcDVW
      MlZUV1RodVVtNDFlbll5TkhSUWJGSkdVVk5xZWtscWMxSlNhVVJvYzA1UWFGUlRhd3AxZGxkYVdI
      SjBWVlpoUlQwS1BVMDNMek1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  become: true
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ insights_remediation | regex_search('\\s[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# Nginx performance can be improved when pinning Nginx worker processes to individual CPUs
# Identifier: (advisor:nginx_worker_cpu_affinity|NGINX_WORKER_CPU_AFFINITY,fix)
# Version: 614c89d8595b1392f7a7970b548b4719f8799764
- name: Update worker_cpu_affinity in configuration file on host
  hosts: "ansible-ap2,ansible-ap2hub"
  become: true
  vars:
    pydata: "{{ insights_report.details['nginx_worker_cpu_affinity|NGINX_WORKER_CPU_AFFINITY'] | default('') }}"

    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldUVkxhRTVOZG5jMU9FUXJhalZ3VGtGUloyUjZaeThyVUdaa2Fu
      UXJLM0pIT1U5YVlsWkZhWEl4V1RWTlR6bHhXVGQ2Y0dzeVlWY0tXV1E1YkhKWmRFOTJSRVpPWVRk
      dllqVXdZMFJqYzB0S2NqWmFkRXhyZGtJMU5tbDRhRkpGUlVFdlZFUnhlRUl5V1VSWVRGTkJRbUZH
      WjNacGFHbHlWUW95UTFOSlZrNUJlVnBPYW1WTWExY3lUVU5NZFZGa2MwWXJjbUZ4ZUhZelMwTm5T
      bUpXUkVGcVYwbFNUbXdyZW5CVVFYZERhVVJtZUUxT2VVMUdhbEpqQ2pKV1dFcHFXREJ0V1d4ek9V
      WTFORmh1YVZkS1dWQnVSbmRNVURGSWNFRTNSR1I1VFVaWlJXRkZZbXhhUkcxaWVIWnNhRUZEZG5o
      bFdISk1UVEZ6Y1ZZS2FuSk5hbVV4ZWpCQ2RWYzNSakJQTkRoclozSndkRXRyU20xUE1VdEdSeTk0
      YVRCRmNuRm5jVEZZU214Mlkxa3dhMEl5UWtseGNYZFVXVGR4T1dRMWVRcENZbTlJYldGUk5URlZU
      M042VGl0d2FYVXZORmRVTjJWbmNVaGllRmwyTVdaSk1XdEZXbmd4V25aNE4yaFZVaTh6WkZnNU1V
      RlVjRUV4Ulc1YVMxRkJDbFJrVGpWSVRGQTBUVVpWTkhKa2NraHpkVlJUUzI1emNsTkZUakJKY1hw
      RlVsb3ZOR1oyV0VSS2MyOUNTRmd5Y25OSllrdDVUWG8yY1dGSllYZ3pjVWtLYjJ0T1JFWnFia1Zu
      TkhKaE5rZHZNV1l5YW1aT2VWcHFTbXhFVTJKaVRWazFkSGMwWldablFtcDBhSFE0TW05WFJqbGlO
      WFpKYldScFZuTlZUWEJuUmdvMFkzQkVURkY1TlROdllYSmpTM2REWm05ak1XdHRja0p3V1ZOUFEx
      WndkRGRyZUVjeVRtNVpjRk5yTldZMlpVOXlVblU1YUc1WlltTm9jMFpGVjI4eENqTndSazAzWm1O
      c09GUnhTRE5RU205NVVsWm1lVFZpU2t0U09HODJTM2d6VWs5elR6TnFSbUY2VjBSMGIzVlRkM295
      YlhKUVFXRm5abXBCTW05SVVqWUtSRXd3TDJOdlZXMUtjREprSzBORGJsWnNjV2xrUW0xa2FtNXVR
      aTlwU1RaRFdFSlVORU5UYlU1VVNEVlNiREZSYlROakwxRnhORTVQVVRjeVMxWmhkUXBtYTFOTVVs
      bEVibkJWYnowS1BXdGpSbUlLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: Update nginx option
      lineinfile:
        path: "{{ item.value[0] }}"
        line: worker_cpu_affinity auto;
        backup: yes
      with_dict: "{{ pydata.rpmsinfo }}"

    - name: Restart nginx service
      service:
        name: "{{ item.key }}"
        state: restarted
      with_dict: "{{ pydata.rpmsinfo }}"


# The postgresql database performance decreases when the tuned best practices are not applied
# Identifier: (advisor:tuned_profiles_postgresql|TUNED_PROFILES_POSTGRESQL,fix)
# Version: b3cbd2fd91299c5bd38faad059e605dfc2336420
- name: Install required packages and set proper tuned profile
  hosts: "ansible-ap2db,ansible-ap2hub"
  become: true
  vars:
    pydata: "{{ insights_report.details['tuned_profiles_postgresql|TUNED_PROFILES_POSTGRESQL'] | default('') }}"

    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldXdGxkbEE0ZG5jMU9FUXJhalZ3VGtGUmFWUnNVa0ZCYTAxa2FV
      d3ZjVlZpYzI5bk1IQXlWamhwYVZSU1lWRXdaRVYxU2t0amVXOEtUbFl4VmxNdmJqSnhNVVZzYTFC
      aGRqVk1ORzFvZUU1M1dHUTFWRkJhYTAxTGRFWnNVSE5yTnprNE1FNVFRemxPTkdkaVZqTjZZbnBq
      TlNzMWFUWnVWZ28xVkZCbEwydERUR0l2Y0djeldtdGxZMEpZYzNKWk0wRmlWbmxrUTJWMFJFTXdO
      VmhKVlVaR2IzVlNOMnR3UVhwWU9WWlVORWhXUlRjMmFUWXhSRWQ1Q2pKMVMyVktZMmxFTWtsaVVV
      cE5OamxwY0dGbFFYZDJUa3BJTDBWRUwxbzRaWE56UkhSSWRGTTBiRGRMVDBoNkszQnlhblJ1U0RR
      dldURjFNMlF5UXpJS0syUTRZMk50VDJWRmNVODJRaXRIY0c1aFlVbFJjbkZSYjNsVlpWcE5lRzky
      U0RjMGVUZFhia2hsWjJSTWQyNUVMMGhpTWs1U1ZuUlZVRm81YWsxUk1Rb3hhVFZPYjNGTlJGazRT
      SEJaWmtKcmFUWm1TVEl2T1dzeVRFOHJkWFo2YnpFd1ZqWkxhSEZQT1VOeWJVdzFhSGxrYVVGUlJr
      WnpRbFJzTldRdmNIRnpDbFYwT0RrNVlXNHpZbkZzV1RKYU1rcEVPREZPYXpaT1NqZFVWbWxqZVV4
      V1FtWktSVk55UkM5amRqQXJUV3cxZEZkekwwWk1aV2xrTld0VGRGcFVibVlLTm1KaFpWRXlObll3
      UmpkUlJpdFlTV1JtY2pWbVRFVkpRekpzYkd0U1ozVjNjWGhYYlVsSk9FMTBMelptVUVneVFUSlha
      MDVSVTI1bE1FYzNhRmRYS3dwS2NVaDBlV3RIV0RGNFptZEJhR2RLYzBaUWJrZEVlbXRWU0ZobmFs
      cE9ObE5oV1haMWFIZHdjRlppVmtzNWFrTklSRmhUSzFGalMyZGlUSGxMYTJnM0NqRk9NRnBTYUds
      T01FRTNlR2hRSzFZeWFWUkJlRE42VW1sa05qUkRVVk5vVXpGWVVXbElVbmxpYzJSMGRIaHFMMnha
      TTFORmVHSjJiWEZvWkdoV04zZ0tVMFo0TUV4QlNIZFFiVVIxV1ZVeU9XTlZUa3MzZFVsS1dTdGxV
      a3g1YWtzd2QzWm5PVFJ4U0hCaGNqaFZURWx5YzJST1dWRTNUWFJCVDJ4Nk5IUTFaUXA2YTNoNmRX
      MDFVWEJuTUQwS1BYbG9ZVE1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - when:
        - pydata is defined
        - pydata.tuned_profiles_postgresql is not defined
      block:
        - name: Enable fast-datapath repo
          command: subscription-manager repos --enable=fast-datapath-for-rhel-8-x86_64-rpms
          when: pydata.yumrepo is not defined

        - name: Install the tuned-profiles-postgresql package
          yum:
            name: tuned-profiles-postgresql
            state: latest

    - name: Enable tuned profile postgresql
      command: tuned-adm profile postgresql


- name: run insights
  hosts: "ansible-ap2,ansible-ap2db,ansible-ap2hub"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false